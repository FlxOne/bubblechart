/**
 * BubbleChart (1.1.2)
 *
 * Author: Jonathan D. Johnson (http://jondavidjohn.com)
 * Homepage: https://github.com/jondavidjohn/bubblechart
 * Issue Tracker: https://github.com/jondavidjohn/bubblechart/issues
 * License: Apache 2.0
 */
(function(){this.BubbleChart=function(){function a(b){var c,d,e,f=this;this.o=b,this.data=b.data||[],this.metric=b.metric,this.fillColors=b.fillColors||[],this.contain=b.contain||!1,this.gutter=b.gutter||0,this.canvas=document.getElementById(b.canvasId),null==b.attribution&&(b.attribution="before"),b.attribution&&(e="https://github.com/jondavidjohn/bubblechart",c=document.createElement("div"),c.className="bubblechart-attribution",c.innerHTML='<small>(Powered by <a href="'+e+'">BubbleChart</a>)</small>',"before"===b.attribution&&this.canvas.parentNode.insertBefore(c,this.canvas),"after"===b.attribution&&this.canvas.parentNode.insertBefore(c,this.canvas.nextSibling)),d=document.createComment(" BubbleChart by jondavidjohn (http://jondavidjohn.github.io/bubblechart/) "),null!=this.canvas.firstChild?this.canvas.insertBefore(d,this.canvas.firstChild):this.canvas.appendChild(d),this.pointer=new a.Pointer,function(c){var d;return c.context=c.getContext("2d"),d=a.getPixelRatio(c.context),c.style.height=""+c.height+"px",c.style.width=""+c.width+"px",c.width=c.width*d,c.height=c.height*d,c.style.position="relative",c.onmousemove=c.ontouchmove=f.pointer.e_move,c.onmousedown=c.ontouchstart=f.pointer.e_grab,c.onmouseup=c.onmouseout=c.ontouchend=f.pointer.e_release,c.style.webkitUserSelect="none",c.area=c.height*c.width,c.usableArea=c.area*(b.usedArea||.2),c.midpoint=new a.Point(c.width/2,c.height/2),f.spinner=new a.Spinner(f.canvas.context)}(this.canvas),this.data.length&&this.reload()}return a.getBackingStoreRatio=function(a){return a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1},a.getPixelRatio=function(b){var c,d;return d=window.devicePixelRatio||1,c=a.getBackingStoreRatio(b),d/c},a.prototype.reload=function(){var b,c,d,e,f,g,h;for(this.bubbles=[],this.metricTotal=function(){var a,c,d,e;for(d=this.data,e=[],a=0,c=d.length;c>a;a++)b=d[a],e.push(b.data);return e}.call(this).reduce(function(a,b){return a+b}),g=this.data,h=[],e=0,f=g.length;f>e;e++)b=g[e],d=function(a){return a[a.length?Math.randInt(a.length):void 0]}(this.fillColors),c={href:b.href,label:b.label,metric:b.metric||this.o.metric,data:b.data,img_src:b.img_src,img_area:b.img_area,fillColor:b.fillColor||d,borderColor:b.borderColor||this.o.borderColor,textColor:b.textColor||this.o.textColor,textFont:b.textFont||this.o.textFont,borderSize:b.borderSize||this.o.borderSize,radius:Math.sqrt(this.canvas.usableArea*(b.data/this.metricTotal))/2,popoverOpts:this.o.popoverOpts,position:new a.Point(Math.randInt(Math.sqrt(this.canvas.area)),Math.randInt(Math.sqrt(this.canvas.area))),pointOfGravity:this.canvas.midpoint},this.bubbles.push(new a.Bubble(c)),h.push(this.canvas.context.clearRect(0,0,this.canvas.width,this.canvas.height));return h},a.prototype.advance=function(){var a,b,c,d,e,f;for(e=this.bubbles,f=[],c=0,d=e.length;d>c;c++)a=e[c],a.advance(this),f.push(function(){var c,d,e,f;for(e=this.bubbles,f=[],c=0,d=e.length;d>c;c++)b=e[c],a.label!==b.label&&a.overlapsWith(b)&&a.resolveCollisionWith(b),this.contain?f.push(b.pushAwayFromEdges(this.canvas,this.gutter)):f.push(void 0);return f}.call(this));return f},a.prototype.paint=function(a){var b,c,d,e,f,g,h,i,j,k,l=this;for(null==a&&(a=!0),this.pointer.grabbingBubble()||(this.canvas.style.cursor="default"),this.pointer.grabbingBubble()||(this.pointer.bubble=null),setTimeout(function(){return l.advance()},0),i=this.bubbles,c=0,f=i.length;f>c;c++)b=i[c],null!=b.last_draw&&b.clear(this.canvas.context);for(j=this.bubbles,d=0,g=j.length;g>d;d++)b=j[d],null!=b.popover.last_draw&&b.popover.clear(this.canvas.context),this.pointer.grabbingBubble()||null!=this.pointer.current&&this.pointer.current.distance(b.position)<=b.radius&&(this.pointer.bubble=b);for(k=this.bubbles,e=0,h=k.length;h>e;e++)b=k[e],b.paint(this.canvas.context);return null!=this.pointer.bubble&&(this.canvas.style.cursor="pointer",this.pointer.bubble.popover.paint(this.pointer,this.canvas.context)),a?requestAnimationFrame(function(){return l.paint()}):void 0},a}()}).call(this),function(){BubbleChart.Bubble=function(){function a(a){this.grabbed=!1,this.bully=!1,this.pointOfGravity=a.pointOfGravity,this.href=a.href,this.label=a.label,this.metric=a.metric,this.data=a.data,this.img_src=a.img_src,this.fillColor=a.fillColor,this.borderColor=a.borderColor,this.textColor=a.textColor,this.textFont=a.textFont||"helvetica",this.borderSize=a.borderSize,this.radius=a.radius,this.position=a.position,this.diameter=2*this.radius,this.reach=this.radius+1,this.img_area=a.img_area||.8,null!=this.borderSize&&(this.reach+=this.borderSize),this.popover=new BubbleChart.Popover(this,a.popoverOpts||{}),this.pre=null,this.img=new Image,this.last_draw=null,this.render()}return a.prototype.getVelocity=function(){return{x:.04*(this.pointOfGravity.x-this.position.x),y:.04*(this.pointOfGravity.y-this.position.y)}},a.prototype.advance=function(a){var b,c;return this.grabbed?(b=a.pointer,null!=b.current&&null!=b.diff?(this.position.x=b.current.x-b.diff.x,this.position.y=b.current.y-b.diff.y):void 0):(c=this.getVelocity(),this.position.x+=c.x,this.position.y+=c.y)},a.prototype.distanceFrom=function(a){return this.position.distance(a.position)-(this.reach+a.reach)},a.prototype.overlapsWith=function(a){return this.distanceFrom(a)<0},a.prototype.hasSpatialInferiorityTo=function(a){return a.grabbed||a.radius>this.radius&&!this.grabbed||a.radius>this.radius&&this.bully&&a.bully&&!this.grabbed||a.bully&&!this.grabbed},a.prototype.resolveCollisionWith=function(a){var b,c,d,e;return this.overlapsWith(a)?(b=this.position.distance(a.position),c=this.distanceFrom(a),e=b-c,this.hasSpatialInferiorityTo(a)?(d=this.position.rAngle(a.position),this.position.x=a.position.x+e*Math.cos(d),this.position.y=a.position.y+e*Math.sin(d),this.bully=!0):(d=a.position.rAngle(this.position),a.position.x=this.position.x+e*Math.cos(d),a.position.y=this.position.y+e*Math.sin(d),a.bully=!0)):void 0},a.prototype.pushAwayFromEdges=function(a,b){return this.position.y-this.reach+b<0?(this.position.y=this.reach-b,this.bully=!0):this.position.y+this.reach-b>a.height?(this.position.y=a.height-this.reach+b,this.bully=!0):this.position.x+this.reach-b>a.width?(this.position.x=a.width-this.reach+b,this.bully=!0):this.position.x-this.reach+b<0?(this.position.x=this.reach-b,this.bully=!0):void 0},a.prototype.paint=function(a){return null!=this.pre?(this.last_draw={x:this.position.x-this.radius,y:this.position.y-this.radius,w:this.pre.width,h:this.pre.height},a.drawImage(this.pre,this.last_draw.x,this.last_draw.y,this.last_draw.w,this.last_draw.h)):void 0},a.prototype.render=function(){var a,b,c,d,e,f,g=this;if(null!=this.img_src&&(this.img.onload=function(){var a,b,c,d,e,f,h;for(b=document.createElement("canvas"),c=b.getContext("2d"),a=BubbleChart.getBackingStoreRatio(c),g.img_src.indexOf("@2x")===!1?(g.img.height=g.img.height/2,g.img.width=g.img.width/2):a>1&&(g.img.height=g.img.height/a,g.img.width=g.img.width/a);g.img.width>g.diameter*g.img_area;)g.img.height=.75*g.img.height,g.img.width=.75*g.img.width;return b.height=g.img.height,b.width=g.img.width+2,e=g.img.width/2+2,f=g.img.height/2,d=g.img.width/2,c.save(),c.beginPath(),c.arc(e,f,d,0,2*Math.PI,!0),c.closePath(),c.clip(),c.drawImage(g.img,1,0,g.img.width,g.img.height),c.restore(),c.arc(e,f,g.img.width/2,0,2*Math.PI,!0),c.lineWidth=1,c.strokeStyle=g.fillColor,c.stroke(),h=g.pre.getContext("2d"),h.drawImage(b,g.radius-b.width/2,g.radius-(g.img.height-g.img.width)/2-g.img.width/2,b.width,b.height)},this.img.src=this.img_src),this.pre=document.createElement("canvas"),a=this.pre.getContext("2d"),b=BubbleChart.getPixelRatio(a),this.pre.height=this.pre.width=(this.diameter+3)*b,a.beginPath(),a.fillStyle=this.fillColor,a.arc(this.radius+1,this.radius+1,this.radius,0,2*Math.PI,!0),a.fill(),null!=this.borderColor&&(a.lineWidth=this.borderSize,a.strokeStyle=this.borderColor,a.stroke()),this.textColor)if(a.font=""+20*b+"px '"+this.textFont+"'",a.fillStyle=this.textColor,e=a.measureText(this.label),e.width+12<this.diameter)c=this.radius-e.width/2,d=this.radius+7,a.fillText(this.label,c,d);else if(a.font=""+12*b+"px helvetica",e=a.measureText(this.label),e.width+7<this.diameter)c=this.radius-e.width/2,d=this.radius+2,a.fillText(this.label,c,d);else{for(f=""+this.label+"...";f&&e.width+7>=this.diameter;)f=f.substr(0,f.length-4).concat("..."),"..."===f&&(f=!1),e=a.measureText(f);f&&(c=this.radius-e.width/2,d=this.radius+2,a.fillText(f,c,d))}return a.closePath()},a.prototype.clear=function(a){return null!=this.last_draw?(a.clearRect(this.last_draw.x-5,this.last_draw.y-5,this.last_draw.w+10,this.last_draw.h+10),this.last_draw=null):void 0},a}()}.call(this),function(){BubbleChart.Point=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.slope=function(a){var b,c;return b=this.y-a.y,c=this.x-a.x,b/c},a.prototype.angle=function(a){return 180*this.rAngle(a)/Math.PI+180},a.prototype.rAngle=function(a){return Math.atan2(this.y-a.y,this.x-a.x)},a.prototype.diff=function(a){return{x:this.x-a.x,y:this.y-a.y}},a.prototype.distance=function(a){var b;return b=this.diff(a),Math.sqrt(b.x*b.x+b.y*b.y)},a}()}.call(this),function(){BubbleChart.Pointer=function(){function a(){var a;this.current=null,this.bubble=null,this.diff=null,this.moving=!1,this.dragging=!1,a=this,this.e_move=function(){var b;return b=null,function(c){return clearTimeout(b),a.current=a.getPosition(c),a.moving=!0,a.grabbingBubble()&&(c.preventDefault(),a.dragging=!0),b=setTimeout(function(){return a.moving=!1},50)}}(),this.e_grab=function(b){return null!=a.bubble?(b.preventDefault(),a.bubble.grabbed=!0,a.diff=a.current.diff(a.bubble.position),a.current=null):void 0},this.e_release=function(b){return a.grabbingBubble()&&(b.preventDefault(),a.bubble.grabbed=!1,a.diff=null,a.dragging||"undefined"!=typeof window&&null!==window&&null!=a.bubble.href&&(window.location.href=a.bubble.href),a.dragging=!1),"mouseout"===b.type?a.current=null:void 0}}return a.prototype.grabbingBubble=function(){return null!=this.bubble&&this.bubble.grabbed},a.prototype.getPosition=function(){var a,b;return b={},a={},function(c){var d,e,f,g,h;if(d=c.target||c.srcElement,e=d.id,f=BubbleChart.getPixelRatio(d.getContext("2d")),null==b[e]||null==a[e])for(b[e]=0,a[e]=0;;)if(b[e]+=d.offsetTop||0,a[e]+=d.offsetLeft||0,d=d.offsetParent,!d)break;return c.touches&&c.touches.length>0?(g=c.touches[0].pageX-a[e],h=c.touches[0].pageY-b[e]):(g=c.pageX-a[e],h=c.pageY-b[e]),new BubbleChart.Point(g*f,h*f)}}(),a}()}.call(this),function(){BubbleChart.Popover=function(){function a(a,b){this.bubble=a,this.fillColor=b.fillColor||"#333",this.textColor=b.textColor||"#FFF",this.textFont=b.textFont||"helvetica",this.opacity=b.opacity||.8,this.labelSize=b.labelSize||18,this.metricSize=b.metricSize||12,this.last_draw=null,this.textDems={},this.pre=null}return a.prototype.getTextDems=function(a,b,c,d){var e,f,g;return null==this.textDems[""+b+c+d]&&(a.font=""+c+"px '"+d+"'",g=a.measureText(b).width,e=document.createElement("span"),e.style.fontSize=""+c+"px",e.style.fontFamily=d,e.style.visibility="hidden",e.textContent=b,document.body.appendChild(e),f=e.offsetHeight,document.body.removeChild(e),this.textDems[""+b+c+d]={width:g,height:f}),this.textDems[""+b+c+d]},a.prototype.calculateTriangle=function(a,b,c){var d;return d={x:0,y:0,x2:0,y2:0,x3:0,y3:0},d.x-=a/2,d.x2=d.x+a/2,d.x3=d.x+a,d.y+=b>0?b-26*c:b+48*c,d.y2=d.y+b,d.y3=d.y,d},a.prototype.paint=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(null!=a.current)return p=BubbleChart.getPixelRatio(b),g=this.labelSize,n=this.metricSize,l=8*p,q=5*p,t=16*p,s=8*p,o=""+this.bubble.data+" "+this.bubble.metric,f=this.getTextDems(b,this.bubble.label,g,this.textFont),m=this.getTextDems(b,o,n,this.textFont),k=(Math.max(f.width,m.width)+2*l)*p,j=Math.max(f.height,m.height)*p,c=2*j+2*q,h=a.current.x-14*p,i=a.current.y-c-s-2*q,0>i?(i=a.current.y+40*p,r=this.calculateTriangle(t,-s,p)):r=this.calculateTriangle(t,s,p),r.x+=a.current.x,r.y+=a.current.y,r.x2+=a.current.x,r.y2+=a.current.y,r.x3+=a.current.x,r.y3+=a.current.y,h+k>b.canvas.width&&(h-=h+k-b.canvas.width),this.last_draw={x:h,y:i-s,w:k+2,h:c+2*s},b.beginPath(),b.fillStyle=this.fillColor,b.globalAlpha=this.opacity,b.roundedRect(h,i,k,c,7*p),b.moveTo(r.x,r.y),b.lineTo(r.x2,r.y2),b.lineTo(r.x3,r.y3),b.lineTo(r.x,r.y),b.fill(),b.globalAlpha=1,b.fillStyle=this.textColor,b.font=""+g*p+"px "+this.textFont,b.fillText(this.bubble.label,h+l,i+j),b.font=""+n*p+"px "+this.textFont,d=h+l,e=i+2*j,b.fillText(o,d,e),b.closePath()},a.prototype.clear=function(a){return null!=this.last_draw?(a.clearRect(this.last_draw.x,this.last_draw.y,this.last_draw.w,this.last_draw.h),this.last_draw=null):void 0},a}()}.call(this),function(){BubbleChart.Spinner=function(){function a(a){this.context=a,this.running=!1,this.lines=12,this.start_date=null}return a.prototype.start=function(){return this.running=!0,this.start_date=new Date,this.paint()},a.prototype.paint=function(){var a,b,c,d,e=this;for(b=parseInt((new Date-this.start_date)/1e3*this.lines)/this.lines,this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.rotate(2*Math.PI*b),this.context.scale(.4,.4),a=c=0,d=this.lines;d>=0?d>c:c>d;a=d>=0?++c:--c)this.context.beginPath(),this.context.rotate(2*Math.PI/this.lines),this.context.moveTo(this.context.canvas.width/7,0),this.context.lineTo(this.context.canvas.width/4,0),this.context.lineWidth=this.context.canvas.width/50,this.context.strokeStyle="rgba(0,0,0,"+a/this.lines+")",this.context.stroke();return this.context.restore(),this.running?requestAnimationFrame(function(){return e.paint()}):this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},a.prototype.stop=function(){return this.running=!1},a}()}.call(this),function(){CanvasRenderingContext2D.prototype.roundedRect=function(a,b,c,d,e){return 2*e>c&&(e=c/2),2*e>d&&(e=d/2),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e)},Math.randInt=function(a){return null==a&&(a=100),Math.floor(Math.random()*a)},function(){var a,b,c;for(a=0,c=["webkit","moz"];!window.requestAnimationFrame&&c.length;)b=c.pop(),window.requestAnimationFrame=window[b+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b+"CancelAnimationFrame"]||window[b+"CancelRequestAnimationFrame"];return window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c,d,e;return c=(new Date).getTime(),e=Math.max(0,16-(c-a)),d=window.setTimeout(function(){return b(c+e)},e),a=c+e,d}),window.cancelAnimationFrame?void 0:window.cancelAnimationFrame=function(a){return clearTimeout(a)}}()}.call(this);